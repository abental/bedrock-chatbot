version: '3.8'

services:
  bedrock-chatbot:
    build:
      context: ./src
      dockerfile: ../Dockerfile
    container_name: bedrock-chatbot
    ports:
      - "${APP_PORT:-5000}:5000"
    environment:
      # AWS Configuration
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      
      # Bedrock Knowledge Base Configuration
      - KNOWLEDGE_BASE_ID=${KNOWLEDGE_BASE_ID}
      - DATA_SOURCE_ID=${DATA_SOURCE_ID}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-abt-knowledge-base}
      
      # Bedrock Model Configuration
      - MODEL_ID=${MODEL_ID:-anthropic.claude-3-5-sonnet-20241022-v2:0}
      - MAX_TOKENS=${MAX_TOKENS:-1000}
      - TEMPERATURE=${TEMPERATURE:-0.7}
      
      # Flask Configuration
      - FLASK_SECRET_KEY=${FLASK_SECRET_KEY:-dev-secret-key-change-in-production}
      - FLASK_DEBUG=${FLASK_DEBUG:-False}
      - APP_PORT=5000
      
      # Admin Configuration
      - ADMIN_PASSWORD_FILE=/app/config/admin_password.txt
      
    volumes:
      # Mount config directory for admin password
      - ../config:/app/config:ro
      # Mount uploads directory (optional, for persistence)
      - ./uploads:/tmp/uploads
      # Mount .env file if exists (optional)
      - ./.env:/app/.env:ro
    networks:
      - bedrock-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  bedrock-network:
    driver: bridge

